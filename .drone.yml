workspace:
  base: /root/go-projects/
  path: src/git.ultraware.nl/NiseVoid/qb

pipeline:
  clone:
    image: plugins/git
    tags: true

  test:
    image: registry.ultraware.nl/go-build:latest
    pull: true
    environment:
      - CGO_ENABLED=0
    commands:
      - make setup
      - go get git.ultraware.nl/NiseVoid/funlen
      - make test
      - VERBOSE="-v" make test
      - make lint
    when:
      event: [ push, tag, pull_request ]

  PostgreSQL:
    image: registry.ultraware.nl/go-build:latest
    pull: true
    environment:
      - CGO_ENABLED=0
      - POSTGRES_TESTHOST=pgsql
    commands:
      - make setup
      - VERBOSE="-v" make test_postgres
    when:
      event: [ push, tag, pull_request ]

  MySQL:
    image: registry.ultraware.nl/go-build:latest
    pull: true
    environment:
      - CGO_ENABLED=0
      - MYSQL_TESTHOST=mariadb
    commands:
      - make setup
      - VERBOSE="-v" make test_mysql
    when:
      event: [ push, tag, pull_request ]

  MSSQL:
    image: registry.ultraware.nl/go-build:latest
    pull: true
    environment:
      - CGO_ENABLED=0
      - MSSQL_TESTHOST=172.22.0.25
    commands:
      - make setup
      - VERBOSE="-v" make test_mssql
    when:
      event: [ push, tag, pull_request ]

services:
  pgsql:
    image: postgres:9.6.3-alpine
    pull: true
    environment:
      - DB_HOST=postgres
      - POSTGRES_USER=qb_test
      - POSTGRES_DB=qb_test

  mariadb:
    image: mariadb:10.3
    pull: true
    environment:
      - MYSQL_DATABASE=qb_test
      - MYSQL_USER=qb_test
      - MYSQL_PASSWORD=qb_test
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
